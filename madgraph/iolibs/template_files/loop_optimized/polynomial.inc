C THE SUBROUTINE TO CREATE THE COEFFICIENTS FROM LAST LOOP WF AND 
C MULTIPLY BY THE BORN

      SUBROUTINE %(mp_prefix)s%(proc_prefix)sCREATE_LOOP_COEFS(LOOP_WF,RANK,LCUT_SIZE,LOOP_GROUP_NUMBER,SYMFACT,COLOR_ID,HELCONFIG)
	  implicit none
C  
C CONSTANTS 
C 
	  %(nbornamps_decl)s
	  %(real_format)s ZERO,ONE
	  PARAMETER (ZERO=%(zero_def)s,ONE=%(one_def)s)
	  %(complex_format)s IMAG1
      PARAMETER (IMAG1=(ZERO,ONE))
	  %(complex_format)s CMPLX_ZERO
	  PARAMETER (CMPLX_ZERO=(ZERO,ZERO))
	  INTEGER MAXLWFSIZE
	  PARAMETER (MAXLWFSIZE=%(max_lwf_size)d)
	  INTEGER LOOPMAXCOEFS
	  PARAMETER (LOOPMAXCOEFS=%(loop_max_coefs)d)
      INTEGER    NCOLORROWS
	  PARAMETER (NCOLORROWS=%(nloopamps)d)
	  INTEGER    NLOOPGROUPS
      PARAMETER (NLOOPGROUPS=%(nloop_groups)d)
	  INTEGER    NCOMB
      PARAMETER (NCOMB=%(ncomb)d)
C     These are constants related to the split orders
      INTEGER    NSO, NSQUAREDSO, NAMPSO
	  PARAMETER (NSO=%(nSO)d, NSQUAREDSO=%(nSquaredSO)d, NAMPSO=%(nAmpSO)d)
C  
C ARGUMENTS 
C  
      %(complex_format)s LOOP_WF(MAXLWFSIZE,0:LOOPMAXCOEFS-1,MAXLWFSIZE)
	  INTEGER RANK, COLOR_ID, SYMFACT, LCUT_SIZE, HELCONFIG, LOOP_GROUP_NUMBER
C  
C LOCAL VARIABLES 
C
      %(complex_format)s CFTOT
      %(complex_format)s CONST(NAMPSO)
      INTEGER I,J
C  
C FUNCTIONS
C
      INTEGER %(proc_prefix)sML5SOINDEX_FOR_BORN_AMP, %(proc_prefix)sML5SOINDEX_FOR_LOOP_AMP, %(proc_prefix)sML5SQSOINDEX
C
C GLOBAL VARIABLES
C
	  INTEGER CF_D(NCOLORROWS,%(color_matrix_size)s)
	  INTEGER CF_N(NCOLORROWS,%(color_matrix_size)s)
	  common/%(proc_prefix)sCF/CF_D,CF_N

	  LOGICAL CHECKPHASE
	  LOGICAL HELDOUBLECHECKED
      common/%(proc_prefix)sINIT/CHECKPHASE, HELDOUBLECHECKED

	  INTEGER HELOFFSET
	  INTEGER GOODHEL(NCOMB)
	  LOGICAL GOODAMP(NSQUAREDSO,NLOOPGROUPS)
	  common/%(proc_prefix)sFilters/GOODAMP,GOODHEL,HELOFFSET

      %(complex_format)s LOOPCOEFS(0:LOOPMAXCOEFS-1,NSQUAREDSO,NLOOPGROUPS)
	  common/%(proc_prefix)s%(mp_prefix)sLCOEFS/LOOPCOEFS

	  INTEGER HELPICKED
	  common/%(proc_prefix)sHELCHOICE/HELPICKED

	  %(born_amps_decl)s
      
	  DO I=1,NAMPSO
	    CONST(I)=CMPLX_ZERO
      ENDDO

      DO I=1,NBORNAMPS
	    CFTOT=CMPLX(CF_N(COLOR_ID,I)/(ONE*ABS(CF_D(COLOR_ID,I))),ZERO,KIND=%(kind)d)
	    IF(CF_D(COLOR_ID,I).LT.0) CFTOT=CFTOT*IMAG1
	    CONST(%(proc_prefix)sML5SOINDEX_FOR_BORN_AMP(I))=CONST(%(proc_prefix)sML5SOINDEX_FOR_BORN_AMP(I))+CFTOT*CONJG(AMP(I))
	  ENDDO
	  
      DO I=1,NAMPSO
	    IF (CONST(I).NE.CMPLX_ZERO) THEN
	      CONST(I)=CONST(I)/SYMFACT
	      IF (.NOT.CHECKPHASE.AND.HELDOUBLECHECKED.AND.HELPICKED.EQ.-1) THEN
	        CONST(I)=CONST(I)*GOODHEL(HELCONFIG)
	      ENDIF
	      CALL %(mp_prefix)s%(proc_prefix)sMERGE_WL(LOOP_WF,RANK,LCUT_SIZE,CONST(I),LOOPCOEFS(0,%(proc_prefix)sML5SQSOINDEX(I,%(proc_prefix)sML5SOINDEX_FOR_LOOP_AMP(COLOR_ID)),LOOP_GROUP_NUMBER))
	    ENDIF
      ENDDO

	  END
